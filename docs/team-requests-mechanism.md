# Механизм заявок и приглашений в команду (подтверждение по e‑mail для доступа в Bitrix24)

Документ описывает единый механизм управления **заявками в команду** и **приглашениями в команду** с обязательным подтверждением по e‑mail для выдачи доступа к рабочему пространству Bitrix24.

Принцип: **Bitrix24 является единственным источником правды** по составу команды, заявкам и приглашениям. Портал Informika выступает витриной (read‑only): показывает статусы/состав и даёт навигацию, не ведёт отдельного состояния заявок и не отправляет письма вместо Bitrix24.

Ключевое требование: **участник получает доступ к рабочему пространству Bitrix24 только после подтверждения приглашения из e‑mail**, отправленного от имени **модератора** или **стейкхолдера**.

Связанные документы: [statuses-table.md](statuses-table.md), [automation-table.md](automation-table.md), [interface-elements.md](interface-elements.md), [tech-spec-F2.md](tech-spec-F2.md).

---

## 1. Роли

- **Участник** — кандидат в команду (подаёт заявку / принимает приглашение).
- **Модератор** — рассматривает заявки, отправляет приглашения, контролирует подтверждения.
- **Стейкхолдер** — может приглашать участников и/или утверждать заявки по своим идеям/направлениям, контролирует состав команды.
- **Система** — хранение статусов и состава команды в Bitrix24, отправка e‑mail‑приглашений из Bitrix24, отображение данных и навигация в портале.

> Примечание: роли координатора/экспертов могут быть добавлены отдельными правилами, но в этом документе они не являются обязательными.

---

## 2. Термины и сущности

### 2.1 TeamRequest («Заявка в команду»)

Единая запись в **CRM Bitrix24** (смарт‑процесс CRM `TeamRequest` в отдельной воронке), которая отражает **намерение участия** в команде идеи и является основным рабочим инструментом модератора/стейкхолдера (канбан‑воронка со стадиями):

- **тип**: `application` (заявка от участника) или `invitation` (приглашение от модератора/стейкхолдера);
- **целевая сущность**: `idea_id` (идея в статусе `Одобрена`, рабочая область Bitrix24 уже создана);
- **целевая роль** в команде (Тимлид/Аналитик/Разработчик/…);
- **стадия воронки (CRM)** — рабочее состояние в Bitrix24; в портале агрегируется в «статус заявки» по [statuses-table.md](statuses-table.md): `На рассмотрении` → (`Ожидает E-mail подтверждения` → `В команде` | `Отклонена`) → `Архив`.
- **источник данных и статусов:** Bitrix24; портал отображает запись и её состояние read‑only через API.

### 2.2 BitrixInvite («Приглашение Bitrix24»)

Техническая сущность/событие в Bitrix24, которое выдаёт доступ в рабочую группу/проект и подтверждается пользователем по e‑mail.

Важно: **без подтверждения BitrixInvite** пользователь не получает доступ к рабочему пространству Bitrix24 (задачи/документы/чат).

---

## 3. Статусная модель (как отражается в UI)

Источник статусов и подтверждений — Bitrix24. Портал отражает состояние read‑only и показывает пользователю необходимые инструкции/переходы.

### 3.1 Статусы TeamRequest (как отображаются в портале)

- `На рассмотрении` — заявка/приглашение создано, ожидается решение модератора/стейкхолдера.
- `Ожидает E-mail подтверждения` — приглашение Bitrix24 отправлено, подтверждение не получено (**доступ в Bitrix24 ещё не выдан**).
- `В команде` — приглашение подтверждено, доступ к рабочему пространству Bitrix24 выдан.
- `Отклонена` — отказ (со стороны модератора/стейкхолдера или отказ участника от приглашения).
- `Архив` — завершённая запись для истории.

> Отдельной «метки подтверждения» в портале нет: ожидание/факт e‑mail‑подтверждения отражаются статусами `Ожидает E-mail подтверждения` и `В команде`.

---

## 4. Потоки

### 4.1 Подача заявки участником (`application`)

1) Участник нажимает `Вступить в команду` в карточке идеи.  
2) Заполняет форму (роль, уровень компетенции, комментарий, ссылки/портфолио) и отправляет.  
3) В Bitrix24 создаётся TeamRequest типа `application` в стадии `Новая` (в портале отображается как `На рассмотрении`; портал не хранит отдельную копию).  
4) Модератор/стейкхолдер рассматривает заявку в Bitrix24:
   - `Принять` → переводит карточку TeamRequest в стадию «Одобрено / Отправить приглашение»; Bitrix24 инициирует BitrixInvite (e‑mail из Bitrix24 с указанием инициатора) и переводит карточку в «Ожидает E-mail подтверждения» (в портале статус станет `Ожидает E-mail подтверждения`).
   - `Отклонить` → переводит карточку в стадию «Отклонена» (обязательна причина) (в портале статус станет `Отклонена`).
5) Пока BitrixInvite не подтверждено: в заявке отображается статус `Ожидает E-mail подтверждения`, а переходы/кнопки Bitrix24 в портале недоступны.
6) После подтверждения BitrixInvite: портал получает актуальный состав/доступы из Bitrix24, статус меняется на `В команде`, появляется кнопка `Открыть рабочее пространство`.

### 4.2 Приглашение участника модератором/стейкхолдером (`invitation`)

1) Модератор/стейкхолдер открывает карточку идеи в Bitrix24 (из портала — по кнопке `Открыть в Bitrix24`) и создаёт приглашение участнику.  
2) В Bitrix24 выбирает пользователя (по e‑mail/ФИО), роль и добавляет комментарий.  
3) В Bitrix24 создаётся TeamRequest типа `invitation` в стадии «Одобрено / Отправить приглашение».  
4) Bitrix24 отправляет BitrixInvite (e‑mail) и переводит карточку в стадию «Ожидает E-mail подтверждения» (в портале статус станет `Ожидает E-mail подтверждения`).  
5) Участник подтверждает приглашение по e‑mail → Bitrix24 выдаёт доступ и переводит карточку в стадию «В команде» (в портале статус станет `В команде`), становятся доступны переходы в рабочее пространство.

### 4.3 Подтверждение приглашения по e‑mail (обязательное)

- В e‑mail есть кнопка `Подтвердить участие` (ведёт в Bitrix24).
- После подтверждения в Bitrix24 портал синхронизирует состояние одним из способов:
  - **webhook**/событие от Bitrix24 (предпочтительно);
  - **периодический опрос** Bitrix API по членству/инвайтам (fallback).

### 4.4 Отказ, отзыв, истечение

- **Участник отказался** (по ссылке в e‑mail Bitrix24 или через интерфейс Bitrix24): TeamRequest → `Отклонена` (причина: «Отказ участника»).
- **Модератор/стейкхолдер отозвал** приглашение до подтверждения: BitrixInvite отменяется (если возможно), TeamRequest → `Архив` с причиной.
- **Истечение**: если приглашение не подтверждено за N дней (например, 7), оно помечается как истекшее в Bitrix24; переотправка/создание нового приглашения выполняется инициатором в Bitrix24.

### 4.5 Инструмент модератора/стейкхолдера в Bitrix24: CRM‑воронка TeamRequest (без фильтров)

Для модератора и стейкхолдера управление заявками/приглашениями выполняется **в CRM Bitrix24** (смарт‑процесс `TeamRequest`) в формате **воронки (канбан) со стадиями**, без проектирования отдельных таблиц/фильтров на портале.

**Как обеспечивается «без фильтров»**
- Стейкхолдер видит только записи по своим идеям за счёт прав доступа/ответственности в Bitrix24 (ему не нужно отбирать вручную).
- Модератор работает с общей воронкой и обрабатывает карточки по колонкам стадий (все «новые/на рассмотрении» всегда в одном месте).
- Для работы по конкретной идее используется вход из карточки идеи в Bitrix24 в связанный список TeamRequest (связь «Идея → Заявки в команду»), который уже ограничен этой идеей.

**Стадии воронки (рекомендуемый набор)**
- `Новая` — запись создана (заявка участника с портала или приглашение вручную); в портале отображается как `На рассмотрении`.
- `На рассмотрении` — назначен ответственный, идёт оценка; в портале `На рассмотрении`.
- `Одобрено / Отправить приглашение` — стадия‑триггер: при входе в стадию Bitrix24 отправляет BitrixInvite (e‑mail) и автоматически переводит в `Ожидает E-mail подтверждения`; в портале становится `Ожидает E-mail подтверждения`.
- `Ожидает E-mail подтверждения` — письмо отправлено, ожидается подтверждение участником; в портале `Ожидает E-mail подтверждения`.
- `В команде` — приглашение подтверждено, доступ выдан, участник состоит в рабочей группе/проекте Bitrix24; в портале `В команде`.
- `Отклонена` — отказ (обязательна причина); в портале `Отклонена`.
- `Архив` — завершённая запись (снята/закрыта/отозвана/истекла); в портале `Архив`.

**Правила переходов (минимум)**
- `Новая/На рассмотрении` → `Одобрено / Отправить приглашение` (обязательна роль; система отправляет BitrixInvite).
- `Новая/На рассмотрении/Ожидает E-mail подтверждения` → `Отклонена` (обязательна причина).
- `Ожидает E-mail подтверждения` → `В команде` — автоматически по событию подтверждения.
- Любая финальная стадия → `Архив` — вручную (для завершения истории), либо автоматически по внутренней политике.

---

## 5. Элементы интерфейса

Ниже перечислены элементы UI, которые должны быть реализованы/обновлены для поддержки механизма.

### 5.1 Карточка идеи (участник)

- Блок `Команда` (read‑only состав) + кнопка `Вступить в команду` (если участник не в команде и идея `Одобрена`).
- Модальное окно `Вступить в команду`:
  - поля: `Целевая роль`, `Уровень компетенции`, `Опыт/успехи`, `Ссылки/портфолио`, чекбокс согласия;
  - кнопки: `Отправить заявку`, `Отмена`.
- Блок `Моё участие` (если есть заявка/приглашение):
  - статус заявки: `На рассмотрении` / `Ожидает E-mail подтверждения` / `В команде` / `Отклонена`;
  - при `Ожидает E-mail подтверждения`: инструкция «Подтвердите приглашение в письме (Bitrix24). Если письма нет — обратитесь к модератору/стейкхолдеру»;
  - при `В команде`: кнопка `Открыть рабочее пространство` (Bitrix24), ссылки `Перейти к задачам`/`Перейти к документам`.

### 5.2 Карточка идеи (модератор/стейкхолдер)

- Блок `Заявки в команду` (read‑only):
  - счётчики по данным Bitrix24: `На рассмотрении`, `Ожидает E-mail подтверждения`, `В команде`, `Отклонена`;
  - (опционально) последние 3–5 событий/изменений по заявкам;
  - управление заявками/приглашениями выполняется в CRM Bitrix24 (кнопка `Открыть в Bitrix24`), без фильтров на портале.
- Блок `Команда`:
  - список активных участников (подтверждённых) + роль;
  - список ожидающих подтверждения (если требуется показать отдельно);
  - управление составом выполняется в Bitrix24 (добавление/исключение/роли).
- Кнопка `Открыть в Bitrix24` (или `Управлять командой`) — переход к воронке TeamRequest/рабочему пространству, где выполняются действия.

### 5.3 ЛК участника → `Заявки в команду`

Раздел предназначен для полного цикла взаимодействия участника с командой идеи: подача заявок, получение приглашений, подтверждение участия через e‑mail и переход в рабочее пространство Bitrix24.

#### 5.3.1 Навигация и общая структура

- Раздел доступен в боковом меню ЛК: `Заявки в команду`.
- Верхняя панель:
  - заголовок `Заявки в команду`;
  - поиск (по названию идеи, роли, ФИО инициатора, статусу);
  - фильтр по статусу (Все / На рассмотрении / Ожидает E-mail подтверждения / В команде / Отклонена / Архив);
  - переключатель `Непрочитанные/Все` (для событий по заявкам, если используется общий механизм `+N`).
- Подвкладки (табы):
  - `Все` — объединённая лента заявок и приглашений;
  - `Отправленные` — заявки типа `application`, созданные участником;
  - `Приглашения` — приглашения типа `invitation`, отправленные модератором/стейкхолдером;
  - `Моя команда` — подтверждённые участия (участник состоит в команде и имеет доступ к Bitrix24);
  - `Архив` — завершённые записи (отклонённые, отозванные, снятые/истекшие).

#### 5.3.2 Карточка заявки/приглашения (унифицированная)

Карточка используется и для `application`, и для `invitation`.

- Заголовок: `Идея: <название>` + ссылка `Открыть идею`.
- Метаданные:
  - тип: `Заявка` или `Приглашение`;
  - роль: `<целевая роль>`;
  - инициатор: `Вы` (для `Отправленные`) или `Модератор/Стейкхолдер: <ФИО>` (для `Приглашения`);
  - дата создания, дата последнего обновления.
- Статус: круглый индикатор статуса TeamRequest (`На рассмотрении/Ожидает E-mail подтверждения/В команде/Отклонена/Архив`).
- Текст/комментарий: мотивация участника (для `Заявка`) или комментарий инициатора (для `Приглашение`) — 1–3 строки.
- Кнопка `Подробнее` открывает детальную карточку заявки (см. 5.3.4).

#### 5.3.3 Действия участника по статусам

> Важно: подтверждение участия, необходимое для доступа Bitrix24, выполняется **через ссылку в e‑mail**. Портал не изменяет статусы заявок и не заменяет подтверждение.

- Статус `На рассмотрении`: только просмотр (решение принимает модератор/стейкхолдер в Bitrix24).
- Статус `Ожидает E-mail подтверждения`:
  - информер: «Чтобы получить доступ к рабочему пространству Bitrix24, подтвердите приглашение в письме».
- Статус `В команде`:
  - `Открыть рабочее пространство` (ведёт в Bitrix24, новая вкладка);
  - быстрые ссылки: `Перейти к задачам`, `Перейти к документам` (если доступны для роли).
- Статус `Отклонена`: отображение причины (если есть), только просмотр.
- Статус `Архив`: только просмотр; действие `Восстановить` не предусмотрено; повторная попытка — новая заявка.

#### 5.3.4 Детальная карточка заявки (`Подробнее`)

- Шапка: название идеи, роль, тип (заявка/приглашение), статус.
- Блок `История`:
  - создание (кто, когда);
  - решение (одобрена/отклонена, кто, когда, причина);
  - отправки e‑mail (дата/статус доставки);
  - подтверждение BitrixInvite (когда подтверждено).
- Блок `Комментарии` (опционально): переписка по заявке (участник ↔ инициатор), без публикации в общий комментарий идеи.
- Блок `Инструкции`:
  - как найти письмо и подтвердить приглашение;
  - что делать при отсутствии письма (проверка спама, актуальность e‑mail, запросить у инициатора переотправку приглашения в Bitrix24).

#### 5.3.5 Пустые состояния и ошибки

- Если e‑mail в профиле не подтверждён: в разделе показывается баннер «Подтвердите e‑mail, иначе вы не сможете получить доступ к Bitrix24 по приглашению».
- Пустые списки:
  - `Приглашения`: «Пока нет приглашений в команды».
  - `Отправленные`: «Вы ещё не подавали заявки в команды».
  - `Моя команда`: «Вы пока не состоите в командах одобренных идей».
- Ошибки:
  - «Не удалось загрузить данные из Bitrix24, попробуйте позже» (вместе с кнопкой `Повторить`).
  - «Приглашение истекло» (если введён срок действия) + предложение запросить новое приглашение у инициатора.

### 5.4 Уведомления

#### Внутренние уведомления (лента портала)

- «Вас пригласили в команду идеи <…> — подтвердите приглашение в письме».
- «Ваша заявка одобрена — ожидает E-mail подтверждения».
- «Приглашение подтверждено — доступ к рабочему пространству открыт».
- «Заявка отклонена: <причина>».

#### E‑mail (обязательный канал для подтверждения)

- Тема: «Приглашение в команду идеи <…>».
- Тело: кто приглашает (модератор/стейкхолдер), роль, короткий комментарий, кнопка `Подтвердить участие`.
- Ссылки: `Подтвердить участие`, `Отказаться` (опционально), `Связаться` (ссылка на карточку идеи/уведомления).

---

## 6. Действия и бизнес‑процессы по ролям

Ниже перечислены возможные действия и бизнес‑процессы в рамках механизма заявок/приглашений с обязательным e‑mail‑подтверждением для доступа к Bitrix24.

### 6.1 Участник

**Действия в портале**
- Подать заявку `Вступить в команду` (создать TeamRequest типа `application` в Bitrix24) для идеи в статусе `Одобрена`.
- Просматривать статусы заявок/приглашений (`На рассмотрении/Ожидает E-mail подтверждения/В команде/Отклонена/Архив`) на данных Bitrix24.
- Перейти в Bitrix24: `Открыть рабочее пространство` / `Перейти к задачам` / `Перейти к документам` (только при статусе `В команде`).

**Действия вне портала (обязательные/технические)**
- Подтвердить приглашение по ссылке из e‑mail (BitrixInvite).
- (Опционально) отказаться от приглашения по ссылке из e‑mail.

**Бизнес‑процессы**
- `BP-01 Подача заявки`: заполнение формы → `На рассмотрении` → ожидание решения.
- `BP-02 Подтверждение участия`: заявка одобрена → `Ожидает E-mail подтверждения` → подтверждение → `В команде` (доступ в Bitrix24).
- `BP-03 Закрытие заявки участником (по запросу)`: `На рассмотрении` → закрытие/архивация в Bitrix24 → `Архив`.

### 6.2 Модератор

**Инструмент в Bitrix24**
- CRM‑смарт‑процесс `TeamRequest`: канбан‑воронка со стадиями (см. 4.5). Обработка выполняется перемещением карточек по стадиям.

**Действия в Bitrix24 (основные)**
- Обрабатывать карточки по колонкам стадий (`Новая/На рассмотрении/Ожидает E-mail подтверждения/…`) без использования фильтров.
- Открыть карточку TeamRequest: проверить кандидата, заполнить роль/комментарий, посмотреть историю отправок/подтверждений.
- Принять заявку: перевести в `Одобрено / Отправить приглашение` (Bitrix24 отправляет BitrixInvite и переводит в `Ожидает E-mail подтверждения`).
- Отклонить заявку: перевести в `Отклонена` (обязательна причина).
- Пригласить участника: создать TeamRequest типа `invitation`, указать роль и перевести в `Одобрено / Отправить приглашение`.
- Контролировать подтверждения: работать с колонкой `Ожидает E-mail подтверждения`, при необходимости переотправлять приглашение/отзывать (по возможностям Bitrix24) с фиксацией причины.
- Завершать историю: переводить завершённые записи в `Архив` (если требуется закрыть цикл и убрать из активных).

**Действия в портале (витрина)**
- Открыть карточку идеи и перейти по кнопке `Открыть в Bitrix24` для управления командой/приглашениями.

**Бизнес‑процессы**
- `BP-04 Рассмотрение заявки`: `Новая/На рассмотрении` → (`Одобрено / Отправить приглашение` | `Отклонена`).
- `BP-05 Приглашение в команду`: создание `invitation` → `Одобрено / Отправить приглашение` → `Ожидает E-mail подтверждения`.
- `BP-06 Контроль подтверждений`: `Ожидает E-mail подтверждения` → (`В команде` | `Отклонена/Архив` по причине).

### 6.3 Стейкхолдер

**Инструмент в Bitrix24**
- CRM‑смарт‑процесс `TeamRequest`: канбан‑воронка со стадиями (см. 4.5). Воронка для стейкхолдера ограничена его идеями правами доступа/ответственностью (без фильтров).

**Действия в Bitrix24 (основные)**
- Просматривать и обрабатывать карточки по стадиям по своим идеям (`Новая/На рассмотрении/Ожидает E-mail подтверждения/…`).
- Принимать/отклонять заявки по своим идеям (переводом карточки в соответствующую стадию; причина отказа обязательна).
- Приглашать участников: создавать TeamRequest типа `invitation`, задавать роль и переводить в `Одобрено / Отправить приглашение`.
- Контролировать подтверждения в колонке `Ожидает E-mail подтверждения`, инициировать повторную отправку/замену кандидата.
- Исключать участника из команды (по политике доступа) с фиксацией причины в Bitrix24 и обновлением состава команды.

**Действия в портале (витрина)**
- Просмотреть состав/статусы и перейти по кнопке `Открыть в Bitrix24` для управления.

**Бизнес‑процессы**
- `BP-07 Закрытие роли`: приглашение/принятие → подтверждение → роль считается закрытой.
- `BP-08 Эскалация`: при неподтверждении в срок — повторная отправка/замена кандидата.

### 6.4 Система

**Автоматические действия**
- Создание TeamRequest и изменение статусов в Bitrix24, запись событий в журнал Bitrix24.
- Инициирование BitrixInvite и отправка e‑mail из Bitrix24 (аудит отправок ведётся в Bitrix24).
- Синхронизация отображения в портале: чтение статусов/состава команды из Bitrix24 (webhook или polling).
- Обработка ошибок интеграции и ограничение повторных запросов (rate‑limit) на уровне интеграции.
- (Опционально) авто‑истечение инвайта по сроку N дней и уведомление инициатора/участника.
- Обновление счётчиков/уведомлений (`+N`) и видимости кнопок перехода в Bitrix24.

---

## 7. Интеграционные и безопасностные требования (минимум)

- Заявки/приглашения и состав команды хранятся в Bitrix24; портал получает их через REST API и отображает read‑only.
- E‑mail‑приглашение и подтверждение участия отправляются Bitrix24 на e‑mail пользователя; e‑mail должен быть верифицирован.
- Параметры токенов/сроков ссылок подтверждения и правила отзыва/истечения инвайтов задаются на стороне Bitrix24.
- Портал не хранит Bitrix‑токены пользователя; синхронизация статуса выполняется сервисным доступом (API key/robot user) по политике ИБ.
- Все действия (создание заявки, решение, приглашение, подтверждение) фиксируются в Bitrix24 и доступны для аудита; портал отображает события и предоставляет навигацию.

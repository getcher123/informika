# Механизм заявок и приглашений в команду (подтверждение по e‑mail для доступа в Bitrix24)

Документ описывает единый механизм управления **заявками в команду** и **приглашениями в команду** с обязательным подтверждением по e‑mail для выдачи доступа к рабочему пространству Bitrix24.

Принцип: **Bitrix24 является единственным источником правды** по составу команды, заявкам и приглашениям. Портал Informika выступает витриной (read‑only): показывает статусы/состав и даёт навигацию, не ведёт отдельного состояния заявок и не отправляет письма вместо Bitrix24.

Ключевое требование: **участник получает доступ к рабочему пространству Bitrix24 только после подтверждения приглашения из e‑mail**, отправленного от имени **модератора** или **стейкхолдера**.

Связанные документы: [statuses-table.md](statuses-table.md), [automation-table.md](automation-table.md), [interface-elements.md](interface-elements.md), [tech-spec-F2.md](tech-spec-F2.md).

---

## 1. Роли

- **Участник** — кандидат в команду (подаёт заявку / принимает приглашение).
- **Модератор** — рассматривает заявки, отправляет приглашения, контролирует подтверждения.
- **Стейкхолдер** — может приглашать участников и/или утверждать заявки по своим идеям/направлениям, контролирует состав команды.
- **Система** — хранение статусов и состава команды в Bitrix24, отправка e‑mail‑приглашений из Bitrix24, отображение данных и навигация в портале.

> Примечание: роли координатора/экспертов могут быть добавлены отдельными правилами, но в этом документе они не являются обязательными.

---

## 2. Термины и сущности

### 2.1 TeamRequest («Заявка в команду»)

Единая запись в Bitrix24 (CRM/задача/элемент), которая отражает **намерение участия** в команде идеи:

- **тип**: `application` (заявка от участника) или `invitation` (приглашение от модератора/стейкхолдера);
- **целевая сущность**: `idea_id` (идея в статусе `Одобрена`, рабочая область Bitrix24 уже создана);
- **целевая роль** в команде (Тимлид/Аналитик/Разработчик/…);
- **статус** — как в [statuses-table.md](statuses-table.md) для «Заявка в команду»: `На рассмотрении` → (`Принята` | `Отклонена`) → `Архив`.
- **источник данных и статусов:** Bitrix24; портал отображает запись и её состояние read‑only через API.

### 2.2 BitrixInvite («Приглашение Bitrix24»)

Техническая сущность/событие в Bitrix24, которое выдаёт доступ в рабочую группу/проект и подтверждается пользователем по e‑mail.

Важно: **без подтверждения BitrixInvite** пользователь не получает доступ к рабочему пространству Bitrix24 (задачи/документы/чат).

---

## 3. Статусная модель (как отражается в UI)

Источник статусов и подтверждений — Bitrix24. Портал отражает состояние read‑only и показывает пользователю необходимые инструкции/переходы.

### 3.1 Статусы TeamRequest (отображаются как основной статус заявки)

- `На рассмотрении` — заявка/приглашение создано, ожидается решение модератора/стейкхолдера.
- `Принята` — решение о включении принято и инициировано приглашение в Bitrix24 (**доступ появится после подтверждения e‑mail**).
- `Отклонена` — отказ (со стороны модератора/стейкхолдера или отказ участника от приглашения).
- `Архив` — завершённая запись для истории.

### 3.2 Техническое состояние BitrixInvite (дополнительная метка рядом со статусом `Принята`)

В интерфейсе рядом со статусом `Принята` показывается уточняющая метка:

- `Ожидает подтверждения` — приглашение отправлено, подтверждение не получено.
- `Подтверждено` — приглашение подтверждено, доступ в Bitrix24 выдан.

> Это не отдельный статус заявки, а **техническое состояние интеграции**, необходимое из‑за обязательного подтверждения по e‑mail.

---

## 4. Потоки

### 4.1 Подача заявки участником (`application`)

1) Участник нажимает `Вступить в команду` в карточке идеи.  
2) Заполняет форму (роль, уровень компетенции, комментарий, ссылки/портфолио) и отправляет.  
3) В Bitrix24 создаётся TeamRequest типа `application` со статусом `На рассмотрении` (портал не хранит отдельную копию).  
4) Модератор/стейкхолдер рассматривает заявку в Bitrix24:
   - `Принять` → в Bitrix24 инициируется BitrixInvite (e‑mail из Bitrix24 с указанием инициатора) и заявка переводится в `Принята`.
   - `Отклонить` → обязательна причина, заявка переводится в `Отклонена`.
5) Пока BitrixInvite не подтверждено: в заявке `Принята` показывается метка `Ожидает подтверждения`, а переходы/кнопки Bitrix24 в портале недоступны.
6) После подтверждения BitrixInvite: портал получает актуальный состав/доступы из Bitrix24, метка меняется на `Подтверждено`, появляется кнопка `Открыть рабочее пространство`.

### 4.2 Приглашение участника модератором/стейкхолдером (`invitation`)

1) Модератор/стейкхолдер открывает карточку идеи в Bitrix24 (из портала — по кнопке `Открыть в Bitrix24`) и создаёт приглашение участнику.  
2) В Bitrix24 выбирает пользователя (по e‑mail/ФИО), роль и добавляет комментарий.  
3) В Bitrix24 создаётся TeamRequest типа `invitation`:
   - статус `На рассмотрении` (до отправки) или сразу `Принята` (если отправка выполнена мгновенно);
   - инициируется BitrixInvite (e‑mail).
4) Участник подтверждает приглашение по e‑mail → выдаётся доступ → портал отображает `Подтверждено` и доступные переходы в Bitrix24.

### 4.3 Подтверждение приглашения по e‑mail (обязательное)

- В e‑mail есть кнопка `Подтвердить участие` (ведёт в Bitrix24).
- После подтверждения в Bitrix24 портал синхронизирует состояние одним из способов:
  - **webhook**/событие от Bitrix24 (предпочтительно);
  - **периодический опрос** Bitrix API по членству/инвайтам (fallback).

### 4.4 Отказ, отзыв, истечение

- **Участник отказался** (по ссылке в e‑mail Bitrix24 или через интерфейс Bitrix24): TeamRequest → `Отклонена` (причина: «Отказ участника»).
- **Модератор/стейкхолдер отозвал** приглашение до подтверждения: BitrixInvite отменяется (если возможно), TeamRequest → `Архив` с причиной.
- **Истечение**: если приглашение не подтверждено за N дней (например, 7), оно помечается как истекшее в Bitrix24; переотправка/создание нового приглашения выполняется инициатором в Bitrix24.

---

## 5. Элементы интерфейса

Ниже перечислены элементы UI, которые должны быть реализованы/обновлены для поддержки механизма.

### 5.1 Карточка идеи (участник)

- Блок `Команда` (read‑only состав) + кнопка `Вступить в команду` (если участник не в команде и идея `Одобрена`).
- Модальное окно `Вступить в команду`:
  - поля: `Целевая роль`, `Уровень компетенции`, `Опыт/успехи`, `Ссылки/портфолио`, чекбокс согласия;
  - кнопки: `Отправить заявку`, `Отмена`.
- Блок `Моё участие` (если есть заявка/приглашение):
  - статус заявки: `На рассмотрении` / `Принята` / `Отклонена`;
  - при `Принята`: метка `Ожидает подтверждения` + текст-инструкция «Подтвердите приглашение в письме (Bitrix24). Если письма нет — обратитесь к модератору/стейкхолдеру»;
  - при `Подтверждено`: кнопка `Открыть рабочее пространство` (Bitrix24), ссылки `Перейти к задачам`/`Перейти к документам`.

### 5.2 Карточка идеи (модератор/стейкхолдер)

- Блок `Заявки в команду`:
  - фильтры: `Все`, `На рассмотрении`, `Принята`, `Отклонена`;
  - строка заявки: ФИО, роль, дата, комментарий, статус + (если `Принята`) метка `Ожидает подтверждения/Подтверждено`.
  - действия: на витрине только просмотр; управление заявками/приглашениями выполняется в Bitrix24 (кнопка `Открыть в Bitrix24`).
- Блок `Команда`:
  - список активных участников (подтверждённых) + роль;
  - список ожидающих подтверждения (если требуется показать отдельно);
  - управление составом выполняется в Bitrix24 (добавление/исключение/роли).
- Кнопка `Открыть в Bitrix24` (или `Управлять командой`) — переход к рабочему пространству/CRM, где выполняются действия.

### 5.3 ЛК участника → `Заявки в команду`

Раздел предназначен для полного цикла взаимодействия участника с командой идеи: подача заявок, получение приглашений, подтверждение участия через e‑mail и переход в рабочее пространство Bitrix24.

#### 5.3.1 Навигация и общая структура

- Раздел доступен в боковом меню ЛК: `Заявки в команду`.
- Верхняя панель:
  - заголовок `Заявки в команду`;
  - поиск (по названию идеи, роли, ФИО инициатора, статусу);
  - фильтр по статусу (Все / На рассмотрении / Принята / Отклонена / Архив);
  - переключатель `Непрочитанные/Все` (для событий по заявкам, если используется общий механизм `+N`).
- Подвкладки (табы):
  - `Все` — объединённая лента заявок и приглашений;
  - `Отправленные` — заявки типа `application`, созданные участником;
  - `Приглашения` — приглашения типа `invitation`, отправленные модератором/стейкхолдером;
  - `Моя команда` — подтверждённые участия (участник состоит в команде и имеет доступ к Bitrix24);
  - `Архив` — завершённые записи (отклонённые, отозванные, снятые/истекшие).

#### 5.3.2 Карточка заявки/приглашения (унифицированная)

Карточка используется и для `application`, и для `invitation`.

- Заголовок: `Идея: <название>` + ссылка `Открыть идею`.
- Метаданные:
  - тип: `Заявка` или `Приглашение`;
  - роль: `<целевая роль>`;
  - инициатор: `Вы` (для `Отправленные`) или `Модератор/Стейкхолдер: <ФИО>` (для `Приглашения`);
  - дата создания, дата последнего обновления.
- Статус: круглый индикатор статуса TeamRequest (`На рассмотрении/Принята/Отклонена/Архив`).
- Метка подтверждения (только если статус `Принята`):
  - `Ожидает подтверждения` — доступ в Bitrix24 ещё не выдан, требуется подтверждение из e‑mail;
  - `Подтверждено` — доступ выдан, участник включён в команду.
- Текст/комментарий: мотивация участника (для `Заявка`) или комментарий инициатора (для `Приглашение`) — 1–3 строки.
- Кнопка `Подробнее` открывает детальную карточку заявки (см. 5.3.4).

#### 5.3.3 Действия участника по статусам

> Важно: подтверждение участия, необходимое для доступа Bitrix24, выполняется **через ссылку в e‑mail**. Портал не изменяет статусы заявок и не заменяет подтверждение.

- Статус `На рассмотрении`: только просмотр (решение принимает модератор/стейкхолдер в Bitrix24).
- Статус `Принята` + метка `Ожидает подтверждения`:
  - информер: «Чтобы получить доступ к рабочему пространству Bitrix24, подтвердите приглашение в письме».
- Статус `Принята` + метка `Подтверждено`:
  - `Открыть рабочее пространство` (ведёт в Bitrix24, новая вкладка);
  - быстрые ссылки: `Перейти к задачам`, `Перейти к документам` (если доступны для роли).
- Статус `Отклонена`: отображение причины (если есть), только просмотр.
- Статус `Архив`: только просмотр; действие `Восстановить` не предусмотрено; повторная попытка — новая заявка.

#### 5.3.4 Детальная карточка заявки (`Подробнее`)

- Шапка: название идеи, роль, тип (заявка/приглашение), статусы и метки подтверждения.
- Блок `История`:
  - создание (кто, когда);
  - решение (принята/отклонена, кто, когда, причина);
  - отправки e‑mail (дата/статус доставки);
  - подтверждение BitrixInvite (когда подтверждено).
- Блок `Комментарии` (опционально): переписка по заявке (участник ↔ инициатор), без публикации в общий комментарий идеи.
- Блок `Инструкции`:
  - как найти письмо и подтвердить приглашение;
  - что делать при отсутствии письма (проверка спама, актуальность e‑mail, запросить у инициатора переотправку приглашения в Bitrix24).

#### 5.3.5 Пустые состояния и ошибки

- Если e‑mail в профиле не подтверждён: в разделе показывается баннер «Подтвердите e‑mail, иначе вы не сможете получить доступ к Bitrix24 по приглашению».
- Пустые списки:
  - `Приглашения`: «Пока нет приглашений в команды».
  - `Отправленные`: «Вы ещё не подавали заявки в команды».
  - `Моя команда`: «Вы пока не состоите в командах одобренных идей».
- Ошибки:
  - «Не удалось загрузить данные из Bitrix24, попробуйте позже» (вместе с кнопкой `Повторить`).
  - «Приглашение истекло» (если введён срок действия) + предложение запросить новое приглашение у инициатора.

### 5.4 Уведомления

#### Внутренние уведомления (лента портала)

- «Вас пригласили в команду идеи <…> — подтвердите приглашение в письме».
- «Ваша заявка принята — подтвердите приглашение в письме».
- «Приглашение подтверждено — доступ к рабочему пространству открыт».
- «Заявка отклонена: <причина>».

#### E‑mail (обязательный канал для подтверждения)

- Тема: «Приглашение в команду идеи <…>».
- Тело: кто приглашает (модератор/стейкхолдер), роль, короткий комментарий, кнопка `Подтвердить участие`.
- Ссылки: `Подтвердить участие`, `Отказаться` (опционально), `Связаться` (ссылка на карточку идеи/уведомления).

---

## 6. Действия и бизнес‑процессы по ролям

Ниже перечислены возможные действия и бизнес‑процессы в рамках механизма заявок/приглашений с обязательным e‑mail‑подтверждением для доступа к Bitrix24.

### 6.1 Участник

**Действия в портале**
- Подать заявку `Вступить в команду` (создать TeamRequest типа `application` в Bitrix24) для идеи в статусе `Одобрена`.
- Просматривать статусы заявок/приглашений и метку подтверждения (`Ожидает подтверждения/Подтверждено`) на данных Bitrix24.
- Перейти в Bitrix24: `Открыть рабочее пространство` / `Перейти к задачам` / `Перейти к документам` (только при `Подтверждено`).

**Действия вне портала (обязательные/технические)**
- Подтвердить приглашение по ссылке из e‑mail (BitrixInvite).
- (Опционально) отказаться от приглашения по ссылке из e‑mail.

**Бизнес‑процессы**
- `BP-01 Подача заявки`: заполнение формы → `На рассмотрении` → ожидание решения.
- `BP-02 Подтверждение участия`: решение `Принята` → письмо → подтверждение → доступ в Bitrix24.
- `BP-03 Закрытие заявки участником (по запросу)`: `На рассмотрении` → закрытие/архивация в Bitrix24 → `Архив`.

### 6.2 Модератор

**Действия в Bitrix24 (основные)**
- Просмотреть список заявок/приглашений по идее, применить фильтры (статус/роль/инициатор).
- Принять заявку участника: зафиксировать роль, отправить BitrixInvite (e‑mail из Bitrix24), перевести TeamRequest в `Принята`.
- Отклонить заявку: обязательная причина, перевод TeamRequest в `Отклонена`.
- Пригласить участника: создать `invitation`, отправить BitrixInvite (e‑mail из Bitrix24).
- Переотправить приглашение/отозвать приглашение (если разрешено политикой Bitrix24), контролировать подтверждения.
- Просматривать журнал действий/событий по заявкам (аудит) в Bitrix24.

**Действия в портале (витрина)**
- Открыть карточку идеи и перейти по кнопке `Открыть в Bitrix24` для управления командой/приглашениями.

**Бизнес‑процессы**
- `BP-04 Рассмотрение заявки`: оценка кандидата → `Принять/Отклонить/Запросить уточнение`.
- `BP-05 Приглашение в команду`: создание `invitation` → e‑mail → ожидание подтверждения.
- `BP-06 Контроль подтверждений`: мониторинг `Ожидает подтверждения` → повторные отправки/эскалации.

### 6.3 Стейкхолдер

**Действия в Bitrix24 (основные)**
- Пригласить участника в команду по своим идеям/направлениям с назначением роли (BitrixInvite, e‑mail из Bitrix24).
- Принять/отклонить заявки по своим идеям (с обязательной причиной при отказе).
- Контролировать подтверждения (кто в статусе «ожидает подтверждения»), инициировать повторную отправку/замену кандидата.
- Исключить участника из команды (при необходимости) с фиксацией причины (в Bitrix24).

**Действия в портале (витрина)**
- Просмотреть состав/статусы и перейти по кнопке `Открыть в Bitrix24` для управления.

**Бизнес‑процессы**
- `BP-07 Закрытие роли`: приглашение/принятие → подтверждение → роль считается закрытой.
- `BP-08 Эскалация`: при неподтверждении в срок — повторная отправка/замена кандидата.

### 6.4 Система

**Автоматические действия**
- Создание TeamRequest и изменение статусов в Bitrix24, запись событий в журнал Bitrix24.
- Инициирование BitrixInvite и отправка e‑mail из Bitrix24 (аудит отправок ведётся в Bitrix24).
- Синхронизация отображения в портале: чтение статусов/состава команды из Bitrix24 (webhook или polling).
- Обработка ошибок интеграции и ограничение повторных запросов (rate‑limit) на уровне интеграции.
- (Опционально) авто‑истечение инвайта по сроку N дней и уведомление инициатора/участника.
- Обновление счётчиков/уведомлений (`+N`) и видимости кнопок перехода в Bitrix24.

---

## 7. Интеграционные и безопасностные требования (минимум)

- Заявки/приглашения и состав команды хранятся в Bitrix24; портал получает их через REST API и отображает read‑only.
- E‑mail‑приглашение и подтверждение участия отправляются Bitrix24 на e‑mail пользователя; e‑mail должен быть верифицирован.
- Параметры токенов/сроков ссылок подтверждения и правила отзыва/истечения инвайтов задаются на стороне Bitrix24.
- Портал не хранит Bitrix‑токены пользователя; синхронизация статуса выполняется сервисным доступом (API key/robot user) по политике ИБ.
- Все действия (создание заявки, решение, приглашение, подтверждение) фиксируются в Bitrix24 и доступны для аудита; портал отображает события и предоставляет навигацию.

# Механизм заявок и приглашений в команду — кратко

## Цель

Обеспечить единый процесс формирования команды идеи с обязательным подтверждением приглашения по e‑mail для выдачи доступа в Bitrix24.

## Принципы

- **Bitrix24 — единственный источник правды** по составу команды, заявкам и приглашениям.
- Портал Informika — **витрина (read‑only)**: показывает статусы и даёт навигацию, но не принимает решения и не выдаёт доступы.
- **Доступ к рабочему пространству Bitrix24 появляется только после подтверждения приглашения из e‑mail** (BitrixInvite).

## Роли

- **Участник** — подаёт заявку / подтверждает приглашение по e‑mail.
- **Модератор** — обрабатывает заявки, отправляет приглашения, контролирует подтверждения.
- **Стейкхолдер** — обрабатывает заявки и приглашает участников по своим идеям.

## Сущности в Bitrix24

- **TeamRequest** — CRM‑смарт‑процесс `TeamRequest` (канбан‑воронка). Описывает заявку/приглашение на участие в команде идеи.
- **BitrixInvite** — приглашение в рабочую группу/проект Bitrix24, подтверждается пользователем по ссылке из e‑mail.

## Смарт‑процесс `TeamRequest`: карточка и поля

Ниже — рекомендуемый состав полей смарт‑процесса `TeamRequest`, который нужен порталу (read‑only) и бизнес‑процессам внутри Bitrix24.

### Стандартные поля Bitrix24 (есть по умолчанию)

- `Название` — формируется автоматически (например, «Команда идеи <ID/название> — <роль> — <ФИО/e‑mail>»).
- `Стадия` (воронка) — текущее состояние обработки (см. стадии ниже).
- `Ответственный` — кто обрабатывает карточку (обычно: стейкхолдер по идее или модератор).
- `Кто создал`, `Дата создания`, `Дата изменения` — системные поля аудита.
- `Лента/таймлайн` (комментарии, дела) — история коммуникаций и событий.

### Бизнес‑поля `TeamRequest` (минимум для работы механизма)

Минимальный набор настраиваемых полей, без которых процесс не работает. Остальные данные (комментарии, причины, аудит, даты) фиксируются в стандартных полях и таймлайне/истории Bitrix24.

| Поле | Тип | Обязательность | Заполняется | Назначение |
|---|---|---|---|---|
| `Идея` | ссылка/ID | обязательно | система/инициатор/портал | к какой идее относится заявка/приглашение |
| `Рабочая группа/проект Bitrix24` | ссылка/ID | обязательно | система/инициатор | куда выдаётся доступ после подтверждения |
| `Тип` | список | обязательно | портал (`application`) / инициатор (`invitation`) | различать заявки участника и приглашения |
| `Целевая роль в команде` | список | обязательно | кандидат (`application`) / инициатор (`invitation`) | какую роль закрываем |
| `E‑mail кандидата` | e‑mail | обязательно | кандидат (`application`) / инициатор (`invitation`) | ключ для отправки приглашения и для сопоставления на портале |

Причины отказа/отзыва фиксируются комментарием в таймлайне Bitrix24 (для стадии `Отклонена` — обязательно).

## CRM‑воронка TeamRequest (работа модератора/стейкхолдера)

Работа выполняется перемещением карточек по стадиям (без фильтров на портале).

Стадии (рекомендуемые):
- `Новая` → `На рассмотрении`
- `Одобрено / Отправить приглашение` (стадия‑триггер отправки BitrixInvite)
- `Ожидает E-mail подтверждения`
- `В команде`
- `Отклонена`
- `Архив`

## Как это отображается в портале

**Статус заявки (по [statuses-table.md](statuses-table.md))**
- `На рассмотрении` (карточка в стадиях `Новая/На рассмотрении`)
- `Ожидает E-mail подтверждения` (письмо отправлено, доступ ещё не выдан)
- `В команде` (приглашение подтверждено, доступ выдан)
- `Отклонена`
- `Архив`

## Основные сценарии

### 1) Заявка участника (application)
- Участник на портале нажимает `Вступить в команду` → отправляет форму.
- В Bitrix24 создаётся карточка TeamRequest (`Новая`) → обработка модератором/стейкхолдером.
- При одобрении: карточка переводится в `Одобрено / Отправить приглашение` → Bitrix24 отправляет e‑mail‑инвайт → `Ожидает E-mail подтверждения`.
- Участник подтверждает e‑mail‑приглашение → `В команде` → доступ к рабочему пространству появляется.

### 2) Приглашение от модератора/стейкхолдера (invitation)

**Где создаётся**
- В Bitrix24: либо из связанного списка `TeamRequest` внутри карточки идеи/рабочей области, либо прямо из канбана смарт‑процесса `TeamRequest`.

**Шаги создания**
1) Нажать `Создать` → выбрать `Тип = invitation`.
2) Заполнить привязки: `Идея`, `Рабочая группа/проект Bitrix24`.
3) Указать `Целевую роль в команде`.
4) Заполнить кандидата (см. «Поиск и привязка пользователя»).
5) Сохранить карточку (она попадает в `Новая/На рассмотрении`) и перевести в стадию `Одобрено / Отправить приглашение`.
6) Bitrix24 отправляет BitrixInvite на указанный e‑mail и переводит карточку в `Ожидает E-mail подтверждения`.
7) После подтверждения приглашения пользователем по ссылке из e‑mail карточка переходит в `В команде`.

**Поиск и привязка пользователя (кандидата)**
- Основной идентификатор — **`E‑mail кандидата`**:
  - по нему отправляется BitrixInvite;
  - по нему портал показывает приглашение пользователю, который вошёл под этим e‑mail.
- Если кандидат **уже есть в Bitrix24**: инициатор находит его через поиск по ФИО/e‑mail и выбирает — e‑mail подставляется в карточку автоматически.
- Если кандидата **ещё нет в Bitrix24**: инициатор вводит e‑mail вручную — Bitrix24 отправит приглашение на этот адрес.

**Важно про отображение на портале**
- Пока приглашение не подтверждено, в портале у пользователя отображается статус `Ожидает E-mail подтверждения`, а переходы в рабочее пространство недоступны.
- После подтверждения — статус `В команде` и появляется переход в Bitrix24.

### 3) Отказ/отзыв/истечение
- Отказ участника по ссылке в письме или в Bitrix24 → `Отклонена`.
- Отзыв инициатором до подтверждения → `Архив` (с причиной).
- (Опционально) истечение по сроку N дней → дальнейшие действия выполняются в Bitrix24 (повторная отправка/новое приглашение).

## UI на портале (минимум)

- **Карточка идеи (участник):** кнопка `Вступить в команду`, блок `Моё участие` со статусом и инструкцией по подтверждению e‑mail.
- **ЛК участника → “Заявки в команду”:** вкладки (все/отправленные/приглашения/моя команда/архив), карточки со статусом, ошибка Bitrix24 + `Повторить`.
- **Карточка идеи (модератор/стейкхолдер):** read‑only счётчики по заявкам и кнопка `Открыть в Bitrix24` (управление — только в CRM Bitrix24).

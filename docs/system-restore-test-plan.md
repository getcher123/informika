# План теста на воссоздание состояния системы

## Цель и критерии успеха

- Цель: с чистого сервера/ВМ за ограниченное время восстановить рабочую среду, идентичную эталону по коду, CRM‑настройкам (СП, воронки, стадии, поля, автоматизации), БП и структуре коробки (ИБ/HL/UF), так чтобы ключевые сценарии прошли.
- Порог успеха:
  - RTO ≤ N часов (замерить фактически).
  - Паритет конфигурации CRM/СП/стадий 100% (контрольные числа, ID, названия).
  - Все миграции sprint.migration применены, `ls` пуст (нет «хвостов»). На первом тесте список миграций может быть изначально пустым — это нормально.
  - Сквозные сценарии «Запрос → Идея → (Проект)» работают (роботы, вебхук).
  - Нет критических ошибок в логах после прогонов.

## Роли и артефакты (до запуска теста)

- Роли: Lead (владелец процесса), Админ CRM, DevOps/Админ ВМ, Наблюдатель (фиксирует время и протокол).
- Нужные артефакты (заранее в репо/хранилище релизов):
  - Тег репозитория `vX.Y.Z` (код в `/local`).
  - Пресет CRM для этого релиза: `/ops/crm-presets/vYYYYMMDD/` (архив).
  - Шаблоны БП (если хранятся отдельно): `/ops/bp/*.bpt`.
  - `bin/migrate`, `local/php_interface/migrations.cfg.php`.
  - Инструкции и карты соответствий ID (`entityTypeId/categoryId/statusId`), если ведёте.
  - Список контрольных значений (чек‑лист паритета): названия СП, стадий, количества полей, названия роботов/триггеров.

## Пошаговый план (2 фазы)

Фаза A — создаём эталон (с тестовыми изменениями) и фиксируем состояние. Фаза B — воссоздаём систему в другой среде по зафиксированным артефактам и меряем RTO.

Примечание о первом тесте: если это первый прогон теста для проекта, исторических миграций может не быть. В таком случае `php bin/migrate ls` уже пуст, а шаг `up` не выполняет изменений. Критерий «миграции применены» трактуем как «ожидаемых к применению миграций нет».

### Фаза A. Подготовка и фиксация эталона

1) Подготовка исходной среды (или staging как «эталон»)
- Среда доступна по SSH/домену, корректные часовой пояс/локаль.

2) Деплой кода и конфигураций
- Переключитесь на релизный тег `vX.Y.Z` (или актуальную ветку для теста).
- Убедитесь, что `local/` соответствует релизу; `bin/migrate` и `migrations.cfg.php` на месте.

3) Применение миграций коробки
```
php bin/migrate ls
php bin/migrate up
```
- Ожидаемо: ошибок нет, `ls` пуст.

4) Импорт/настройка CRM
- Импортируйте или вручную доведите настройки до нужного тестового состояния (СП, воронки/стадии, формы, поля, роботы/триггеры).
- Импортируйте/активируйте шаблоны БП (.bpt), если хранятся отдельно.

5) Создание тестовых данных
- Через формы/карточки создайте семплы: «Запрос», «Идея», пройдите этапы до «Принята», запустите вебхук «Идея→Проект» и убедитесь в создании группы/задач/папок.

6) Фиксация эталона (экспорт и чек‑листы)
- Экспорт CRM пресета: Solution presets → Export → сохраните в `/ops/crm-presets/vYYYYMMDD/`.
- Экспорт шаблонов БП (.bpt) в `/ops/bp/` (если не входят в пресет).
- Зафиксируйте карты соответствий (`entityTypeId/categoryId/statusId`).
- Сформируйте чек‑лист паритета (названия СП/стадий, количества полей, названия роботов/триггеров).
- Убедитесь, что репозиторий помечен тегом `vX.Y.Z` и артефакты привязаны к этому тегу.

Примечание: если эталон уже существует (есть тег кода, пресет и .bpt), Фаза A может быть пропущена.

### Фаза B. Воссоздание в другой среде (с измерением RTO)

1) Старт теста и тайминг
- Запустите таймер. Наблюдатель фиксирует t0, t1, …

2) Подготовка чистой целевой среды
- Новая ВМ (или «чистый» снапшот), сеть/SSH/пользователь настроены.
- Ожидаемо: пинг по домену, SSH доступ, пустой `/home/bitrix/www`.

3) Деплой кода релиза
- Клонируйте репозиторий и/или `rsync` только `/local`.
- Скопируйте `bin/migrate` в `/home/bitrix/www/bin/migrate`, положите `migrations.cfg.php`.
- Проверка: главная страница открывается, логи без ошибок.

4) Импорт пресета CRM
- CRM → Настройки → Solution presets → Import → архив из `/ops/crm-presets/vYYYYMMDD/` → подтвердить.
- Быстрый чек: СП «Запрос»/«Идея», воронки/стадии, карточки/поля/формы, роботы/триггеры активны.

5) Импорт/загрузка БП (.bpt)
- Импортируйте `.bpt` по нужному типу документа и активируйте.

6) Применение миграций коробки
```
cd /home/bitrix/www
php bin/migrate ls
php bin/migrate up
```
- Ожидаемо: `ls` пуст после `up`, ошибок нет. Для первого теста допускается, что `ls` пуст изначально и `up` ничего не делает.

7) Восстановление сервисных интеграций
- Токены/вебхуки/URL backend‑скрипта «Идея→Проект», проверка REST (DNS/firewall).
- Ожидаемо: `curl` на webhook даёт 200/валидный ответ.

8) Сквозной тест (семплы)
- A. Создайте Запрос и Идею; B. Проверьте роботов при переводах стадий; C. «Принята» запускает вебхук и создаёт проект/задачи/папки; поля `groupId/mainTaskId` заполнены.

9) Проверки паритета конфигурации (детально)
- Сверьте контрольные числа: СП/`entityTypeId`, воронки/стадии, пользовательские поля, роботы/триггеры, шаблоны БП.
- Ожидаемо: 100% совпадение с чек‑листом.

10) Проверки безопасности и прав
- Матрица доступа по ролям (автор/эксперт/модератор/стейкхолдер/внешний).

11) Производительность (точечные метрики)
- TTFB/время загрузки ключевых страниц, проверка «лавины» процессов при массовых переводах.

12) Логи и алерты
- Ошибки веб‑сервера/PHP, логи webhook, отсутствие 5xx.

13) Идемпотентность и повторяемость
- Повторный `php bin/migrate up` без изменений; вебхук не создаёт дубли.

14) Завершение теста
- Остановите таймер — зафиксируйте фактический RTO для Фазы B.
- Сводный отчёт: шаги, длительности, узкие места, замечания/фиксы.

## Выходные артефакты теста(опционально)

- Протокол времени (t0…tN), фактический RTO.
- Заполненный чек‑лист паритета (СП/воронки/стадии/поля/роботы/БП).
- Скриншоты ключевых шагов (импорт пресета, список миграций после up, карточки СП, созданный проект).
- Логи webhook и выдержки из `error_log` (по окну теста).
- Список найденных расхождений + задачи в GitHub Issues (назначены, проставлены метки/приоритеты).

## Типичные сбои и быстрые решения

- Не сходятся ID стадий/категорий: проверьте, что импортирован тот же пресет версии; не было ручных правок до импорта.
- Роботы не сработали: отключены из‑за прав/автора пресета → активируйте их в карточке автоматизации; проверьте токены/URL webhook.
- Миграции падают: проверьте права БД/колляцию/кодировку; разбейте долгие операции на шаги; используйте `restart()` в миграции.
- Webhook создал дубликаты: проверьте идемпотентность (ключ идей хранить и проверять перед созданием проекта).
- UI не соответствует: код витрин не того тега — сверить тег `vX.Y.Z` с версией пресета.

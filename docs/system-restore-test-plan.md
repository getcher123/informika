# План теста на воссоздание состояния системы

## Цель и критерии успеха

- Цель: с чистого сервера/ВМ за ограниченное время восстановить рабочую среду, идентичную эталону по коду, CRM‑настройкам (СП, воронки, стадии, поля, автоматизации), БП и структуре коробки (ИБ/HL/UF), так чтобы ключевые сценарии прошли.
- Порог успеха:
  - RTO ≤ N часов (замерить фактически).
  - Паритет конфигурации CRM/СП/стадий 100% (контрольные числа, ID, названия).
  - Все миграции sprint.migration применены, `ls` пуст (нет «хвостов»).
  - Сквозные сценарии «Запрос → Идея → (Проект)» работают (роботы, вебхук).
  - Нет критических ошибок в логах после прогонов.

## Роли и артефакты (до запуска теста)

- Роли: Lead (владелец процесса), Админ CRM, DevOps/Админ ВМ, Наблюдатель (фиксирует время и протокол).
- Нужные артефакты (заранее в репо/хранилище релизов):
  - Тег репозитория `vX.Y.Z` (код в `/local`).
  - Пресет CRM для этого релиза: `/ops/crm-presets/vYYYYMMDD/` (архив).
  - Шаблоны БП (если хранятся отдельно): `/ops/bp/*.bpt`.
  - `bin/migrate`, `local/php_interface/migrations.cfg.php`.
  - Инструкции и карты соответствий ID (`entityTypeId/categoryId/statusId`), если ведёте.
  - Список контрольных значений (чек‑лист паритета): названия СП, стадий, количества полей, названия роботов/триггеров.

## Пошаговый план

### 1) Старт теста и тайминг
- Запустите таймер. Назначьте Наблюдателя фиксировать ключевые точки (t0, t1, …).

### 2) Подготовка чистой среды
- Разверните новую ВМ (или снепшот «чистой»).
- Настройте сеть (IP/домен, напр. `innov.sandbox.local`), SSH, пользователя `dev`.
- Установите кодовую страницу/часовой пояс (как на эталоне).
- Ожидаемо: пинг по домену, доступ по SSH, пустой корень сайта (`/home/bitrix/www`).

### 3) Деплой кода релиза
- Клонируйте репозиторий на ВМ и/или сделайте `rsync` только `/local` на хост.
- Поместите `bin/migrate` в `/home/bitrix/www/bin/migrate`, конфиг миграций — на место.
- Проверка: главная страница открывается (может быть заглушка), логи веб‑сервера без ошибок.

### 4) Импорт пресета CRM (штатный способ)
- Войдите админом в CRM → Настройки → Solution presets → Import.
- Выберите архив `/ops/crm-presets/vYYYYMMDD/`.
- Подтвердите замену конфигурации и дождитесь завершения.
- Проверка паритета (быстрый чек):
  - СП «Запрос» и «Идея» существуют; их `entityTypeId` зафиксированы.
  - Воронки/стадии присутствуют; названия и порядок совпадают с чек‑листом.
  - Карточки/поля/формы на месте (по контрольным числам).
  - Правила автоматизации/триггеры видны и активны.

### 5) Импорт/загрузка БП (.bpt), если не входят в пресет
- Через дизайнер БП импортируйте соответствующие `.bpt` (по типу документа).
- Активируйте шаблоны, проверьте стартовые условия.
- Ожидаемо: нужные шаблоны БП активны, видны в списке.

### 6) Применение миграций коробки (sprint.migration)
- Подключитесь по SSH, перейдите в корень сайта:

```
cd /home/bitrix/www
php bin/migrate ls
php bin/migrate up
```

- При необходимости — прогрев кеша/очистка композита.
- Ожидаемо: список миграций пуст после `up`, ошибок нет.

### 7) Восстановление сервисных интеграций
- Убедитесь, что токены/вебхуки/путь до вашего backend‑скрипта «Идея→Проект» сконфигурированы (env/настройки приложения).
- Проверьте доступность REST‑точек из ВМ (DNS, firewall).
- Ожидаемо: тестовый `curl` к webhook возвращает 200/валидный ответ на пинг‑эндпойнт.

### 8) Создание тестовых данных (семплы) и сквозной тест
- A. CRM формы
  - Создайте Запрос (СП «Запрос») через CRM‑форму или карточку.
  - Создайте Идею, привязанную к запросу (через форму/карточку).
- B. Роботы/БП
  - Переведите Идею на «На уточнении»: робот должен создать задачу/оповещение.
  - Переведите на «На оценке»: создадутся задания экспертам (или активности); внесите оценки.
  - Переведите на «Комиссия»: сформируется пакет/уведомления (если настроено).
- C. Принятие идеи → проект
  - Переведите Идею в «Принята»: сработает вебхук «Идея→Проект».
  - Убедитесь, что создалась группа‑проект, стартовые задачи, папки на Диске; в карточке Идеи записались `groupId/mainTaskId` (или аналогичные поля).
  - Проверьте чат проекта/добавленных участников (если предусмотрено).
- Ожидаемо: весь пайплайн проходит без ручных правок в админке.

### 9) Проверки паритета конфигурации (детально)
- Сверьте «контрольные числа»:
  - Кол‑во СП, их `entityTypeId`.
  - Кол‑во воронок и стадий в каждой (имена и порядок).
  - Кол‑во пользовательских полей по сущностям (названия и типы).
  - Наличие всех роботов/триггеров по стадиям (по наименованиям).
  - Наличие всех шаблонов БП (названия, тип запуска).
- Ожидаемо: 100% совпадение с чек‑листом. Любые расхождения заносятся в протокол.

### 10) Проверки безопасности и прав
- Автор/эксперт/модератор/стейкхолдер: проверьте матрицу доступа (видимость СП, возможность перехода стадий, доступ к проектной группе).
- Внешний участник (если есть Экстранет): нет доступа к CRM, доступ только к проектной группе.
- Ожидаемо: нет прав «лишних», и нет блокеров по ролям.

### 11) Производительность (точечные метрики)
- Откройте 3 ключевые страницы (витрина Запросов, витрина Идей, карточка Идеи) — замерьте TTFB/время загрузки (допускается инструмент браузера).
- Проверка на «лавину» процессов: при массовой смене стадий N элементов (например, 20 идей) роботы не падают по тайм‑аутам, ошибок в логах нет.
- Ожидаемо: выдержаны SLA (например, ≤ 2 с TTFB на витринах).

### 12) Логи и алерты
- Просмотрите ошибки веб‑сервера/PHP за время прогона (`error_log`/nginx).
- Проверьте логи вашего webhook (создание проекта) — запрос/ответ, идемпотентность.
- Зафиксируйте отсутствие 5xx в веб‑журнале.

### 13) Идемпотентность и повторяемость
- Повторно запустите `php bin/migrate up` — изменений быть не должно.
- Повторите перевод Идеи в «Принята» для новой карточки; проверьте, что webhook не создаёт дубликаты при повторном вызове для той же Идеи (идемпотентность).
- Ожидаемо: миграции — устойчивы к повторному запуску; webhook — идемпотентен.

### 14) Завершение теста
- Остановите таймер — зафиксируйте фактический RTO.
- Сводный отчёт: что делали, сколько заняло, где были задержки, список замечаний/фиксов.

## Выходные артефакты теста(опционально)

- Протокол времени (t0…tN), фактический RTO.
- Заполненный чек‑лист паритета (СП/воронки/стадии/поля/роботы/БП).
- Скриншоты ключевых шагов (импорт пресета, список миграций после up, карточки СП, созданный проект).
- Логи webhook и выдержки из `error_log` (по окну теста).
- Список найденных расхождений + задачи в GitHub Issues (назначены, проставлены метки/приоритеты).

## Типичные сбои и быстрые решения

- Не сходятся ID стадий/категорий: проверьте, что импортирован тот же пресет версии; не было ручных правок до импорта.
- Роботы не сработали: отключены из‑за прав/автора пресета → активируйте их в карточке автоматизации; проверьте токены/URL webhook.
- Миграции падают: проверьте права БД/колляцию/кодировку; разбейте долгие операции на шаги; используйте `restart()` в миграции.
- Webhook создал дубликаты: проверьте идемпотентность (ключ идей хранить и проверять перед созданием проекта).
- UI не соответствует: код витрин не того тега — сверить тег `vX.Y.Z` с версией пресета.


# Шаг 5. Репозиторий, ветвление, «как вытянуть папку и держать её актуальной»

Этот документ простыми словами объясняет цель шага 5, отвечает на вопрос «как вытянуть папку и сделать её обновляемой», даёт практические шаги и разбор частых проблем.

## Зачем нужен шаг 5
- Единые правила работы с репозиторием: структура, ветки, сообщения коммитов.
- CODEOWNERS: нужные люди автоматически запрашиваются на ревью.
- Защита ветки `main`: в `main` попадает только код через PR и после проверок.
- Понятный цикл: ветка → коммиты → PR → проверки → ревью → merge.

## Как «вытянуть папку» и обновлять её
Есть два типичных сценария: «один общий репозиторий» и «форк + апстрим».

1) Один общий репозиторий (проще всего)
- Клонируем один раз:
  - HTTPS: `git clone https://github.com/<owner>/<repo>.git`
  - SSH:   `git clone git@github.com:<owner>/<repo>.git`
- Переходим в папку проекта: `cd <repo>` и открываем в VS Code.
- Обновлять до свежего `main` вручную:
  - `git checkout main`
  - `git pull` (получить последние изменения)
- Рабочие изменения делаем в коротких ветках и через PR:
  - `git checkout -b feat/<коротко-задача>`
  - после коммитов: `git push --set-upstream origin feat/<коротко-задача>` → открываем PR.

2) Форк (ваша копия) + Upstream (основной репозиторий)
- На GitHub жмём Fork у основного репозитория.
- Клонируем СВОЙ форк (он будет `origin`).
- Добавляем ссылку на основной репозиторий как `upstream`:
  - `git remote add upstream https://github.com/<owner>/<repo>.git`
  - проверка: `git remote -v` (должны быть origin и upstream)
- Синхронизация с апстримом (основной репо):
  - `git fetch upstream`
  - `git checkout main`
  - `git rebase upstream/main` (или `git merge upstream/main`)
  - `git push` (обновить ваш форк на GitHub)
- Работайте в ветках форка → открывайте PR в основной репозиторий.

Важно: «Автообновляемая папка» буквально не означает, что файлы сами меняются без вашего участия. Обычно делаем авто-fetch (см. ниже), а pull/rebase — осознанно, чтобы не словить конфликты посреди работы.

Дополнительно (опционально): авто-fetch в VS Code
- В VS Code можно включить авто-обновление метаданных (fetch), чтобы видеть, что появилась новая версия в `origin/main`:
  - Settings → поищите `git.autofetch` и включите.
  - Это не делает `pull` автоматически, а только подсказывает о новых коммитах.
- Рекомендуем настроить rebase по умолчанию: `git config --global pull.rebase true`.

Если работаете на ВМ (Bitrix)
- Клонируйте репозиторий на ВМ в `/home/bitrix/www`.
- Открывайте папку через VS Code Remote‑SSH.
- Для обновления кода на ВМ: `git pull` в нужной ветке (обычно `main` для стендов) — сайт обновится из репозитория.

## Принципы работы в ветках (кратко)
- Одна защищённая ветка: `main`.
- Изменения — только через короткие фич‑ветки и Pull Request.
- Именование веток: `feat/...`, `fix/...`, `docs/...`, `chore/...`.
- Сообщения коммитов в стиле Conventional Commits: `feat: ...`, `fix: ...`, `docs: ...` и т. д.

## Практические шаги: протестировать шаг 5
1. Клонировать репозиторий и открыть в VS Code.
2. Создать ветку: `git checkout -b docs/step5-check`.
3. Добавить тестовый файл в `docs/` и закоммитить:
   - `echo "step5 check" > docs/tmp-step5-check.md`
   - `git add docs/tmp-step5-check.md`
   - `git commit -m "docs: add tmp file for step5 check"`
4. Запушить ветку и открыть PR в `main`:
   - `git push --set-upstream origin docs/step5-check`
   - открыть PR на GitHub.
5. Проверить, что:
   - PR нельзя смержить напрямую в `main`, если настроена защита (должны требоваться проверки/ревью).
   - Автозапрос ревью сработал (CODEOWNERS назначил нужных ревьюеров).
   - Шаг 4 CI-проверки зелёные на PR (формат/линты/статический анализ).
6. Проверить запрет прямого пуша в `main`:
   - Попробовать `git checkout main && echo x >> docs/p.txt && git add . && git commit -m "chore: test" && git push` — ожидать отказ из‑за защиты ветки.
7. Удалить временные артефакты:
   - Закрыть PR без merge, удалить `docs/tmp-step5-check.md`, запушить очистку, удалить ветку на GitHub.

## Частые проблемы и решения
- «Permission denied (publickey)» при `git clone` по SSH
  - Проверьте, что добавили SSH‑ключ в GitHub, агент запущен: `ssh -T git@github.com`.
  - Альтернатива — используйте HTTPS URL.
- «Updates were rejected… non‑fast‑forward» при push
  - Сделайте `git fetch` и `git pull --rebase` (или `git rebase origin/main` в вашей ветке), затем снова `git push`.
- Путаю `origin` и `upstream`
  - `origin` — ваш форк/ваш удалённый репозиторий. `upstream` — основной.
  - Посмотреть: `git remote -v`. Исправить URL: `git remote set-url <origin|upstream> <url>`.
- Конфликты при rebase/merge
  - Откройте файлы с конфликтами, разрешите, затем `git add <файл>` и `git rebase --continue` (или завершите merge коммитом).
- «Cannot push to protected branch»
  - Это ожидаемо: пушите в свою ветку, а в `main` — только через PR.
- PR «красный» из‑за проверок
  - Откройте вкладку Checks и исправьте, что указано (обычно формат/линт).
- Нет автозапроса ревью
  - Проверьте файл `CODEOWNERS` и путь к файлам, которые вы меняли.

## Короткий итог
- «Вытянуть папку» = один раз `git clone`.
- «Держать актуальной» = регулярно `git pull` (или `fetch` + rebase), опционально включить авто‑fetch в VS Code.
- В `main` не коммитим напрямую — работаем через ветки и PR, защита ветки и CODEOWNERS помогают держать качество.

